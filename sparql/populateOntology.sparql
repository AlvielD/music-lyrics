PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX core: <http://vivoweb.org/ontology/core#>
PREFIX rdf:		<http://www.w3.org/2000/01/rdf-schema#>
PREFIX rdfs:	<http://www.w3.org/2000/01/rdf-schema#>
PREFIX mm:		<https://w3id.org/polifonia/ontology/music-meta/1.0/>
PREFIX src:		<https://w3id.org/polifonia/ontology/source/1.0/>
PREFIX ml: 		<http://w3id.org/polifonia/ontology/music-lyrics/1.0/>
PREFIX xyz:		<http://sparql.xyz/facade-x/data/>
PREFIX fx:		<http://sparql.xyz/facade-x/ns/>

CONSTRUCT {
  # Metadata
  ?songURI a mm:MusicEntity .
  ?songURI core:hasTitle ?title .
  ?songURI core:hasLanguage ?lang .
  ?songURI mm:isCreatedBy ?creativeProcessURI .
  ?creativeProcessURI a mm:MusicEntity .
  ?creativeProcessURI core:involvesAgent ?MusicArtistURI .
  ?MusicArtistURI core:name ?name .
  
  
  # Annotations
  ?songURI core:hasPart ?abstractScoreURI .
  ?abstractScoreURI a mm:AbstractScore .
  ?abstractScoreURI mm:hasText ?lyricsURI .
  ?lyricsURI a mm:Lyrics .
  ?lyricsURI mm:hasTextPart ?paragraphURI .
  ?paragraphURI a ?paragraphClass .
  
  
  # Time dimension
  ?paragraphURI ml:hasMusicTimeInterval ?musicTimeIntervalURI .
  ?musicTimeIntervalURI a core:MusicTimeInterval .
  
  ?musicTimeIntervalURI core:hasStartMusicTimeIndex ?startMusicTimeIndexURI .
  ?musicTimeIntervalURI core:hasEndMusicTimeIndex ?endMusicTimeIndexURI .
  ?startMusicTimeIndexURI a core:MusicTimeIndex .
  ?endMusicTimeIndexURI a core:MusicTimeIndex .
  
  ?startMusicTimeIndexURI core:hasMusicTimeIndexComponent ?startMusicTimeIndexComponentURI .
  ?endMusicTimeIndexURI core:hasMusicTimeIndexComponent ?endMusicTimeIndexComponentURI .
  ?startMusicTimeIndexComponentURI a core:MusicTimeIndexComponent .
  ?endMusicTimeIndexComponentURI a core:MusicTimeIndexComponent .
  
  ?startMusicTimeIndexComponentURI core:hasValue ?startMusicTimeIndexComponent .
  ?endMusicTimeIndexComponentURI core:hasValue ?endMusicTimeIndexComponent .
  
  
  # Lines
  ?paragraphURI ml:hasTextPart ?linesURI .
  ?linesURI a mm:TextFragment .
  ?linesURI ml:hasValue ?line .	# NOT IMPLEMENTED YET ON THE ONTOLOGY

} WHERE {
  SERVICE <x-sparql-anything:00000000.json> {
    # Metadata
    ?songURI xyz:meta ?metadata .
  	?metadata xyz:title ?titleVar .
    ?metadata xyz:language ?langvar .
    ?metadata xyz:artist ?artistVar .
          
    BIND(fx:entity("https://w3id.org/polifonia/ontology/music-meta/1.0/MusicArtist/",REPLACE(?artistVar, " ", "_", "i")) AS ?MusicArtistURI)
	BIND(fx:entity("https://w3id.org/polifonia/ontology/music-meta/1.0/CreativeProcess/",REPLACE(?titleVar, " ", "_", "i")) AS ?creativeProcessURI)

    BIND(fx:entity(REPLACE(?titleVar, " ", "_", "i")) AS ?title)
    BIND(fx:entity(REPLACE(?langvar, " ", "_", "i")) AS ?lang)
    BIND(fx:entity(REPLACE(?artistVar, " ", "_", "i")) AS ?name)
    
    # Annotations
    ?songURI xyz:annotations ?annotationsContainer .
    ?annotationsContainer fx:anySlot ?annotations .
    ?annotations xyz:paragraph ?paragraphVar .
    ?annotations xyz:time_index ?timeIndexContainer .
    # DOES NOT WORK???
    #?timeIndexContainer rdf:_1 ?startTimeIndexVar .
    #?timeIndexContainer rdf:_2 ?endTimeIndexVar .
    
    # Lines
  	?annotations xyz:lines ?linesContainer .
  	?linesContainer fx:anySlot ?lineVar .
  	?lineVar xyz:line ?lineTextVar .
    
    BIND(fx:entity("https://w3id.org/polifonia/ontology/music-meta/1.0/AbstractScore/",REPLACE(?titleVar, " ", "_", "i")) AS ?abstractScoreURI)
	BIND(fx:entity("https://w3id.org/polifonia/ontology/music-meta/1.0/Lyrics/",REPLACE(?titleVar, " ", "_", "i")) AS ?lyricsURI)
    BIND(fx:entity(
        "https://w3id.org/polifonia/ontology/music-lyrics/1.0/",
        REPLACE(?paragraphVar, " ", "_", "i"),
        "/", ?title
      ) AS ?paragraphURI)
    
    BIND(fx:entity("https://w3id.org/polifonia/ontology/music-lyrics/1.0/",REPLACE(?paragraphVar, " ", "", "i")) AS ?paragraphClass)
    BIND(fx:entity("https://w3id.org/polifonia/ontology/music-lyrics/1.0/TextFragment") AS ?linesURI)
    BIND(xsd:string(?lineTextVar) AS ?line)
    
    BIND(fx:entity("http://vivoweb.org/ontology/core/") AS ?musicTimeIntervalURI)
    
    BIND(fx:entity("http://vivoweb.org/ontology/core/") AS ?startMusicTimeIndexURI)
    BIND(fx:entity("http://vivoweb.org/ontology/core/") AS ?endMusicTimeIndexURI)
    
    BIND(fx:entity("http://vivoweb.org/ontology/core/") AS ?startMusicTimeIndexComponentURI)
    BIND(fx:entity("http://vivoweb.org/ontology/core/") AS ?endMusicTimeIndexComponentURI)
    
    BIND(xsd:integer(?startTimeIndexVar) AS ?startMusicTimeIndexComponent)
    BIND(xsd:integer(?endTimeIndexVar) AS ?endMusicTimeIndexComponent)
  }
}
